#!/bin/bash
set -e
cd "$(dirname "$(dirname "$0")")/book"

new_head='<head><meta charset="utf-8"><title>Abolish the Jesus Trade</title></head>'

# Build HTML
if [[ "$1" != "--skip" ]]; then

    # Build HTML
    cd ..
    export VITE_EXTRA_EXTENSIONS=docx
    VITE_BOOK=pdf node_modules/.bin/vitepress build --outDir book/shared/dist_pdf
    VITE_BOOK=epub node_modules/.bin/vitepress build --outDir book/shared/dist_epub
    cd book

    # Copy HTML to dist root for easier url resolution
    # NOTE This overwrites the existing book.html page which isn't needed anyway
    cp shared/dist_pdf/book_contents/index.html shared/dist_pdf/book.html
    cp shared/dist_epub/book_contents/index.html shared/dist_epub/book.html

    # Remove site assets and meta from <head>
    perl -i -0777 -pe "s|<head>.+?</head>|$new_head|gis" shared/dist_pdf/book.html
    perl -i -0777 -pe "s|<head>.+?</head>|$new_head|gis" shared/dist_epub/book.html

    # Remove <script>
    perl -i -0777 -pe "s|<script.+?</script>||gi" shared/dist_pdf/book.html
    perl -i -0777 -pe "s|<script.+?</script>||gi" shared/dist_epub/book.html

    # Remove any inline styles for consistency (VitePress also adds position:relative to wrapper)
    perl -i -pe 's|style=".*?"||gi' shared/dist_pdf/book.html
    perl -i -pe 's|style=".*?"||gi' shared/dist_epub/book.html

    # Remove Vue stuff and other HTML that is invalid in epub
    perl -i -pe 's|data-v-\w+||gi' shared/dist_epub/book.html
    perl -i -pe 's|tabindex=".*?"||gi' shared/dist_epub/book.html
    perl -i -pe 's|aria-label=".*?"||gi' shared/dist_epub/book.html
    perl -i -pe 's|<section|<div|gi' shared/dist_epub/book.html
    perl -i -pe 's|</section|</div|gi' shared/dist_epub/book.html

    # Remove unsupported attributes from SVGs for EPUB
    find shared/dist_epub -type f -name "*.svg" -exec perl -i -pe 's|aria-label=".*?"||gi' {} \;
    find shared/dist_epub -type f -name "*.svg" -exec perl -i -pe 's|stop-color=".*?"||gi' {} \;

    # Make img URLs relative to dir (--base only affects assets, not absolute image urls etc)
    perl -i -pe 's|src="/|src="./|gi' shared/dist_pdf/book.html
    perl -i -pe 's|src="/|src="./|gi' shared/dist_epub/book.html

    # Convert SVGs to PNGs without alpha for print version
    # NOTE Gets more accurate visuals and avoids transparency issues with KDP etc
    cd shared/dist_pdf
    grep -oP '<img[^>]+src="\K[^"]+\.svg' book.html | while read -r svg; do
        png="${svg%.svg}.png"
        inkscape "$svg" --export-type=png --export-filename="$png" --export-dpi=300 \
            --export-width=1800 --export-background=white --export-png-color-mode=RGB_8
        sed -i "s|$svg|$png|g" book.html
    done
    cd ../..

fi

# Build CSS for PDF
../node_modules/.bin/sass styles_pdf.sass shared/dist_pdf/book.css
perl -i -pe 's|url\(/|url(./|gi' shared/dist_pdf/book.css

# Build CSS for EPUB
../node_modules/.bin/sass styles_epub.sass shared/dist_epub/book.css
perl -i -pe 's|url\(/|url(./|gi' shared/dist_epub/book.css

# Provide epub cover so can access within docker container
cp epub_cover.jpg shared/dist_epub/epub_cover.jpg

# Render to PDF/EPUB
sudo docker build -t sj_book .
sudo docker run --rm --network=host -v "$PWD/shared":/home/app/shared sj_book
